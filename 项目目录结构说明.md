# redis-rs 项目目录结构说明

## 项目概述

redis-rs 是一个高级的 Rust Redis/Valkey 客户端库，支持 RESP（Redis 序列化协议）兼容的数据库。该项目采用 Cargo Workspace 结构，包含多个子 crate。

---

## 根目录文件

### 配置文件

- **`Cargo.toml`** - Workspace 配置文件
  - 定义了工作空间成员：`redis`、`redis-test`、`valkey`、`afl/parser`、`test-macros`
  - 配置了共享依赖（如 `smol`、`tokio`）
  - 使用 Rust 2021 edition resolver

- **`Cargo.lock`** - 依赖锁定文件
  - 锁定所有依赖的精确版本，确保构建的可重复性

- **`rustfmt.toml`** - Rust 代码格式化配置
  - 定义项目的代码风格规范

### 文档文件

- **`README.md`** - 项目主文档
  - 项目介绍和基本使用说明
  - 功能特性说明（异步支持、连接池、TLS、集群、JSON 等）
  - 开发和测试指南

- **`LICENSE`** - BSD-3-Clause 开源许可证

- **`version1.md`** - 版本 1.0 相关说明文档

### 构建和脚本文件

- **`Makefile`** - 项目构建和测试自动化脚本
  - `make build` - 构建核心 crate
  - `make test` - 运行完整测试套件（TCP、TLS、Unix Socket 等）
  - `make bench` - 运行性能基准测试
  - `make docs` - 构建文档
  - `make fuzz` - 运行模糊测试

- **`release.sh`** - 发布脚本
  - 自动化版本发布流程

- **`upload-docs.sh`** - 文档上传脚本
  - 将生成的文档上传到文档托管服务

- **`appveyor.yml`** - AppVeyor CI 配置文件
  - Windows 平台的持续集成配置

---

## 核心目录

### `/redis` - 主 crate 目录

这是项目的核心库，提供 Redis/Valkey 客户端的完整实现。

#### 文件结构

- **`Cargo.toml`** - redis crate 的配置文件
  - 版本：1.0.0-rc.3
  - 包含大量可选特性（features）：
    - 异步运行时：`tokio-comp`、`smol-comp`
    - TLS 支持：`tls-native-tls`、`tls-rustls`
    - 集群支持：`cluster`、`cluster-async`
    - 模块支持：`json`、`vector-sets`
    - 连接池：`r2d2`、`bb8`
    - 其他：`streams`、`geospatial`、`script`、`sentinel` 等

- **`CHANGELOG.md`** - 版本更新日志
- **`LICENSE`** - 许可证文件
- **`release.toml`** - 发布配置

#### `/redis/src` - 源代码目录

核心实现代码，包含以下模块：

**核心模块：**
- **`lib.rs`** - 库入口文件，导出公共 API
- **`client.rs`** - Redis 客户端实现
- **`connection.rs`** - 同步连接实现
- **`cmd.rs`** - 命令构建器
- **`pipeline.rs`** - 管道（批量命令）实现
- **`script.rs`** - Lua 脚本支持
- **`types.rs`** - 类型定义和转换
- **`parser.rs`** - RESP 协议解析器
- **`macros.rs`** - 内部宏定义

**功能模块：**
- **`/aio`** - 异步 I/O 实现
  - `connection.rs` - 异步连接
  - `connection_manager.rs` - 连接管理器（自动重连）
  - `multiplexed_connection.rs` - 多路复用连接
  - `pubsub.rs` - 异步发布/订阅
  - `runtime.rs` - 运行时抽象
  - `tokio.rs` - Tokio 运行时适配
  - `smol.rs` - Smol 运行时适配
  - `monitor.rs` - 监控功能

- **`/commands`** - Redis 命令实现
  - `mod.rs` - 基础命令（Commands trait）
  - `acl.rs` - ACL（访问控制列表）命令
  - `geo.rs` - 地理位置命令
  - `json.rs` - RedisJSON 模块命令
  - `streams.rs` - Stream 数据结构命令
  - `vector_sets.rs` - 向量集合命令
  - `macros.rs` - 命令宏

- **`/cluster_handling`** - 集群支持
  - `client.rs` - 集群客户端
  - `routing.rs` - 集群路由逻辑
  - `slot_map.rs` - 槽位映射
  - `topology.rs` - 集群拓扑管理
  - `/async_connection` - 异步集群连接
  - `/sync_connection` - 同步集群连接

- **`/caching`** - 客户端缓存实现
  - `cache_manager.rs` - 缓存管理器
  - `cmd.rs` - 缓存命令
  - `config.rs` - 缓存配置
  - `sharded_lru.rs` - 分片 LRU 缓存
  - `statistics.rs` - 缓存统计

- **`/errors`** - 错误处理
  - `mod.rs` - 错误类型定义
  - `redis_error.rs` - Redis 错误
  - `server_error.rs` - 服务器错误
  - `parsing_error.rs` - 解析错误

- **`/io`** - 底层 I/O 实现
  - `tcp.rs` - TCP 连接
  - `dns.rs` - DNS 解析

**其他模块：**
- **`sentinel.rs`** - Redis Sentinel 支持（高可用）
- **`tls.rs`** - TLS/SSL 加密连接
- **`r2d2.rs`** - r2d2 连接池集成
- **`bb8.rs`** - bb8 连接池集成
- **`subscription_tracker.rs`** - 订阅跟踪

#### `/redis/examples` - 示例代码

包含各种使用场景的示例：
- **`basic.rs`** - 基础同步使用
- **`async-await.rs`** - 异步/等待模式
- **`async-multiplexed.rs`** - 多路复用连接
- **`async-resp2-pub-sub.rs`** - RESP2 发布/订阅
- **`async-resp3-pub-sub.rs`** - RESP3 发布/订阅
- **`async-scan.rs`** - 异步扫描
- **`async-connection-loss.rs`** - 连接丢失处理
- **`async-caching.rs`** - 客户端缓存
- **`streams.rs`** - Stream 数据结构
- **`geospatial.rs`** - 地理位置功能
- **`typed.rs`** / **`async-typed.rs`** - 类型化命令

#### `/redis/tests` - 测试代码

完整的测试套件：
- **`test_basic.rs`** - 基础功能测试
- **`test_async.rs`** - 异步功能测试
- **`test_cluster.rs`** - 集群测试
- **`test_cluster_async.rs`** - 异步集群测试
- **`test_acl.rs`** - ACL 测试
- **`test_module_json.rs`** - JSON 模块测试
- **`test_streams.rs`** - Stream 测试
- **`test_geospatial.rs`** - 地理位置测试
- **`test_script.rs`** - Lua 脚本测试
- **`test_sentinel.rs`** - Sentinel 测试
- **`test_cache.rs`** - 缓存测试
- **`test_bignum.rs`** - 大数支持测试
- **`test_types.rs`** - 类型转换测试
- **`parser.rs`** - 解析器测试
- **`/support`** - 测试辅助工具
  - `mod.rs` - 测试工具模块
  - `cluster.rs` - 集群测试工具
  - `mock_cluster.rs` - 模拟集群
  - `sentinel.rs` - Sentinel 测试工具
  - `util.rs` - 通用工具

#### `/redis/benches` - 性能基准测试

- **`bench_basic.rs`** - 基础操作性能测试
- **`bench_cluster.rs`** - 集群性能测试
- **`bench_cluster_async.rs`** - 异步集群性能测试
- **`bench_cache.rs`** - 缓存性能测试

---

### `/redis-test` - 测试辅助库

独立的测试工具 crate，为 redis crate 提供测试基础设施。

- **`Cargo.toml`** - 配置文件（版本 0.13.0）
- **`README.md`** - 使用说明
- **`CHANGELOG.md`** - 更新日志
- **`LICENSE`** - 许可证
- **`release.toml`** - 发布配置
- **`/src`** - 源代码
  - 提供测试服务器启动、管理等辅助功能
  - 支持同步和异步测试（通过 `aio` feature）

---

### `/valkey` - Valkey 兼容层

Valkey 是 Redis 的开源分支，此 crate 提供 Valkey 特定的支持。

- **`Cargo.toml`** - 配置文件（版本 0.0.2）
- **`README.md`** - Valkey 说明文档
- **`/src`** - 源代码
  - 提供 Valkey 特定的 API 和功能

---

### `/test-macros` - 测试宏

过程宏 crate，为测试提供宏支持。

- **`Cargo.toml`** - 配置文件
  - 声明为 `proc-macro = true`
  - 依赖 `quote` 和 `syn` 用于宏展开
- **`/src`** - 宏实现代码

---

### `/afl` - 模糊测试

使用 AFL (American Fuzzy Lop) 进行模糊测试。

#### `/afl/parser` - 解析器模糊测试

- **`Cargo.toml`** - 配置文件
- **`/src`** - 模糊测试代码
  - `main.rs` - AFL 模糊测试入口
  - `reproduce.rs` - 崩溃重现工具
- **`/in`** - 测试输入样本
  - `array` - 数组类型样本
  - `array-null` - 空数组样本
  - `bulkstring` - 批量字符串样本
  - `bulkstring-null` - 空批量字符串样本
  - `error` - 错误响应样本
  - `integer` - 整数样本
  - `string` - 字符串样本
  - `invalid-string` - 无效字符串样本

---

## 辅助目录

### `/config` - 配置文件

- **`global.toml`** - 全局配置
- **`redis.toml`** - Redis 特定配置

### `/scripts` - 脚本工具

- **`update-versions.sh`** - 版本更新脚本
  - 自动更新所有 crate 的版本号

### `/target` - 构建输出目录

Cargo 构建生成的目录（通常在 `.gitignore` 中）：
- **`/debug`** - Debug 构建输出
- **`/tmp`** - 临时文件
- **`CACHEDIR.TAG`** - 缓存目录标记

---

## 项目特点

### 1. Workspace 结构
- 多个相关 crate 组织在一个工作空间中
- 共享依赖和配置
- 便于统一管理和发布

### 2. 功能丰富
- **协议支持**：RESP2、RESP3
- **连接方式**：TCP、Unix Socket、TLS
- **异步运行时**：Tokio、Smol
- **集群支持**：Redis Cluster、Sentinel
- **模块支持**：RedisJSON、Vector Sets
- **连接池**：r2d2、bb8
- **客户端缓存**：LRU 缓存实现

### 3. 测试完善
- 单元测试
- 集成测试
- 性能基准测试
- 模糊测试（AFL）
- 多种连接类型测试（TCP、TLS、Unix Socket）

### 4. 文档齐全
- API 文档
- 使用示例
- 更新日志
- 发布说明

---

## 开发工作流

1. **构建**：`make build` 或 `cargo build --locked -p redis`
2. **测试**：`make test`（需要 cargo-nextest）
3. **基准测试**：`make bench`
4. **文档**：`make docs`
5. **模糊测试**：`make fuzz`
6. **代码检查**：`cargo clippy --all-features --all --tests --examples`

---

## 总结

redis-rs 是一个结构清晰、功能完善的 Rust Redis 客户端库。项目采用模块化设计，支持多种使用场景，从简单的同步操作到复杂的异步集群部署都有良好的支持。完善的测试和文档使其成为 Rust 生态中 Redis 客户端的首选。

